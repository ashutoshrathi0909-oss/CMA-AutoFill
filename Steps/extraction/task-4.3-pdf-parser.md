# Task 4.3: PDF Parser (Digital PDFs)

> **Phase:** 04 - Document Extraction
> **Depends on:** Task 4.2 (standardized output format defined)
> **Agent reads:** cma-domain SKILL → Source Document Types
> **Time estimate:** 15 minutes

---

## Objective

Create a parser for text-based (digital) PDFs using pdfplumber. These are PDFs generated by accounting software — they have selectable text, not scanned images.

---

## What to Do

### Create File
`backend/app/services/extraction/pdf_parser.py`

### How to Detect Digital vs Scanned PDF

Before parsing, check if the PDF has extractable text:
1. Open with pdfplumber
2. Extract text from first page
3. If text length > 50 characters → it's a digital PDF → use this parser
4. If text length < 50 characters → it's a scanned PDF → route to Vision extractor (task 4.4)

Create a helper: `is_digital_pdf(file_bytes) → bool`

### Parsing Logic

1. **Open PDF** with pdfplumber
2. **Extract tables first** — pdfplumber's table detection is strong:
   - `page.extract_tables()` finds table structures
   - If tables found → parse them (this is the common case for financial statements)
3. **If no tables found → extract text** and parse line-by-line:
   - Look for patterns: `item_name    amount` (text followed by number)
   - Use regex to separate text from numbers
4. **Detect document type** from text content (same keywords as Excel parser)
5. **Extract line items** into the same standardized format as task 4.2
6. **Handle multi-page PDFs:** financial statements often span 2-3 pages — concatenate all items

### Table Parsing Strategy

When pdfplumber finds a table:
- First row is usually headers (name, amount, or similar)
- Subsequent rows are line items
- Last column(s) are usually amounts
- First column is usually item name
- Handle merged cells and spanning rows

### Text Parsing Strategy (fallback)

When no table structure:
- Split by lines
- For each line, try to extract: text portion and number portion
- Numbers at end of line: `"Sales Revenue    15,00,000"` → name="Sales Revenue", amount=1500000
- Handle Indian number formatting
- Detect group headers (lines without amounts, often bold or uppercase)

### Output

Same standardized JSON format as task 4.2. Must be identical structure so downstream code doesn't care which parser was used.

---

## What NOT to Do

- Don't use AI/Gemini for digital PDFs — pdfplumber is sufficient and free
- Don't handle scanned/image PDFs here (that's task 4.4)
- Don't try to parse password-protected PDFs — return error
- Don't classify items (that's Phase 05)

---

## Verification

- [ ] Digital PDF with tables → extracts all line items correctly
- [ ] Digital PDF without tables (text-only) → extracts via text parsing
- [ ] `is_digital_pdf()` correctly identifies digital vs scanned
- [ ] Multi-page PDF → all items extracted across pages
- [ ] Indian number formatting handled
- [ ] Output format matches task 4.2 standardized format exactly
- [ ] Corrupt/password-protected PDF → clear error message, not crash
- [ ] Empty PDF → clear error

---

## Done → Move to task-4.4-vision-extractor.md
